name: Deploy to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AWS_REGION: ap-northeast-2
  ECR_REPOSITORY: enigma-api

jobs:
  build-and-push:
    name: Build and Push to ECR
    runs-on: ubuntu-latest

    outputs:
      image_uri: ${{ steps.build.outputs.image_uri }}

    steps:
      - name: Free Disk Space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push to ECR
        id: build
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          IMAGE_URI=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

          docker buildx build \
            --cache-from type=gha \
            --cache-to type=gha,mode=max \
            --push \
            -t $IMAGE_URI \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:latest \
            .

          echo "image_uri=$IMAGE_URI" >> $GITHUB_OUTPUT

  deploy:
    name: Deploy to EC2
    needs: build-and-push
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Create .env.production file
        run: |
          cat > .env.production << EOF
          ENV=production
          PORT=4000
          CORS_ORIGIN=${{ secrets.CORS_ORIGIN }}
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          SIGHTENGINE_API_USER=${{ secrets.SIGHTENGINE_API_USER }}
          SIGHTENGINE_API_SECRET=${{ secrets.SIGHTENGINE_API_SECRET }}
          QDRANT_URL=${{ secrets.QDRANT_URL }}
          QDRANT_API_KEY=${{ secrets.QDRANT_API_KEY }}
          NEO4J_URI=${{ secrets.NEO4J_URI }}
          NEO4J_USERNAME=${{ secrets.NEO4J_USERNAME }}
          NEO4J_PASSWORD=${{ secrets.NEO4J_PASSWORD }}
          SERPAPI_KEY=${{ secrets.SERPAPI_KEY }}
          POLICE_FRAUD_URL=${{ secrets.POLICE_FRAUD_URL }}
          POLICE_FRAUD_KEY=${{ secrets.POLICE_FRAUD_KEY }}
          CYBERCOP_URL=${{ secrets.CYBERCOP_URL }}
          GOOGLE_SAFE_BROWSING_KEY=${{ secrets.GOOGLE_SAFE_BROWSING_KEY }}
          HF_TOKEN=${{ secrets.HF_TOKEN }}
          EOF

      - name: Copy files to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "docker-compose.prod.yml,infra/nginx,.env.production"
          target: "/home/ubuntu/app"

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ env.ECR_REPOSITORY }}
          IMAGE_URI: ${{ needs.build-and-push.outputs.image_uri }}
          AWS_REGION: ${{ env.AWS_REGION }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: ECR_REGISTRY,ECR_REPOSITORY,IMAGE_URI,AWS_REGION,AWS_ACCESS_KEY_ID,AWS_SECRET_ACCESS_KEY
          command_timeout: 15m
          script: |
            set -e
            cd /home/ubuntu/app

            echo "=== Current directory contents ==="
            ls -la

            # Install AWS CLI if not present
            if ! command -v aws &> /dev/null; then
              echo "=== Installing AWS CLI ==="
              sudo apt-get update
              sudo apt-get install -y awscli
            fi

            # Configure AWS CLI and login to ECR
            export AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID
            export AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY
            export AWS_DEFAULT_REGION=$AWS_REGION

            echo "=== ECR Login ==="
            aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_REGISTRY

            # 이전 컨테이너 중지 (볼륨은 유지)
            echo "=== Stopping old containers ==="
            docker compose -f docker-compose.prod.yml -f docker-compose.override.yml down --remove-orphans 2>/dev/null || true

            # 오래된 이미지만 정리 (볼륨 보존 — HF 모델 캐시 유지)
            echo "=== Cleaning up old Docker images ==="
            docker image prune -af 2>/dev/null || true
            echo "=== Disk usage after cleanup ==="
            df -h /

            echo "=== Pull image: $IMAGE_URI ==="
            docker pull $IMAGE_URI

            # Create docker-compose override for production
            cat > docker-compose.override.yml << EOF
            services:
              app:
                image: $IMAGE_URI
                build: !reset null
            EOF

            echo "=== docker-compose.override.yml ==="
            cat docker-compose.override.yml

            # Start new containers
            echo "=== Starting containers ==="
            docker compose -f docker-compose.prod.yml -f docker-compose.override.yml up -d

            # Show container status immediately
            echo "=== Container status ==="
            docker ps -a

            # Wait for app container to be running
            echo "=== Waiting for app container ==="
            sleep 10

            # Show app logs
            echo "=== App container logs ==="
            docker logs enigma-app --tail 100 || echo "No app logs yet"

            # Wait for health check (첫 배포 시 HF 모델 다운로드로 최대 5분 소요)
            echo "=== Waiting for application to be healthy ==="
            for i in {1..60}; do
              if curl -sf http://localhost:4000/api/health > /dev/null 2>&1; then
                echo "App is healthy on port 4000!"
                break
              fi
              if curl -sf http://localhost/api/health > /dev/null 2>&1; then
                echo "App is healthy via nginx!"
                break
              fi
              if [ $i -eq 60 ]; then
                echo "Health check timed out after 60 attempts"
                echo "=== App Logs ==="
                docker logs enigma-app --tail 200 || true
                exit 1
              fi
              echo "Attempt $i/60: Waiting..."
              sleep 5
            done

            # Final status
            echo "=== Final container status ==="
            docker ps -a

            echo "=== App logs ==="
            docker logs enigma-app --tail 50 || true

            echo "=== Nginx logs ==="
            docker logs enigma-nginx --tail 20 || true

            echo "Deployment completed!"

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "=== Container Status ==="
            docker ps -a

            echo "=== HF Cache Status ==="
            docker exec enigma-app du -sh /app/.cache/huggingface 2>/dev/null || echo "Cache not accessible"

            echo "=== Health Check ==="
            response=$(curl -sf http://localhost/api/health 2>&1) && {
              echo "Health check passed!"
              echo "$response"
            } || {
              echo "Health check via nginx failed, trying direct..."
              response=$(curl -sf http://localhost:4000/api/health 2>&1) && {
                echo "Direct health check passed!"
                echo "$response"
              } || {
                echo "All health checks failed!"
                echo ""
                echo "=== App Logs ==="
                docker logs enigma-app --tail 100 2>&1 || echo "No app container"
                echo ""
                echo "=== Nginx Logs ==="
                docker logs enigma-nginx --tail 50 2>&1 || echo "No nginx container"
                exit 1
              }
            }
